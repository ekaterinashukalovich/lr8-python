<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Пользователь {{ user.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <body class="container mt-4">

    <h1>Пользователь: {{ user.name }}</h1>

    <ul id="navigation" class="mb-4">
      {% for item in navigation %}
        <li><a href="{{ item.href }}">{{ item.caption }}</a></li>
      {% endfor %}
    </ul>

    <h2>Подписанные валюты</h2>

    {% if currencies %}
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Название</th>
            <th>Код</th>
            <th>Текущий курс (₽)</th>
          </tr>
        </thead>
        <tbody>
          {% for curr in currencies %}
          <tr>
            <td>{{ curr.name }}</td>
            <td>{{ curr.char_code }}</td>
            <td>{{ curr.value }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>Пользователь ни на что не подписан.</p>
    {% endif %}

    <!-- График -->
    {% if datasets %}
    <h3 class="mt-5">График изменения курса за 3 месяца</h3>
<canvas id="historyChart"></canvas>

<script>
    const ctx2 = document.getElementById('historyChart').getContext('2d');

    const historyDataRaw = {{ history | tojson }};
    const datasets2 = [];

    let labels2 = [];

    // Формируем данные для каждой валюты
    for (const cid in historyDataRaw) {
        const item = historyDataRaw[cid];
        const charCode = item.char_code;
        const hist = item.history;

        const dates = hist.map(h => h.date);
        const values = hist.map(h => h.value);

        // Используем самую длинную шкалу дат
        if (dates.length > labels2.length) {
            labels2 = dates;
        }

        datasets2.push({
            label: charCode,
            data: values,
            borderWidth: 2,
            fill: false
        });
    }

    new Chart(ctx2, {
        type: 'line',
        data: {
            labels: labels2,
            datasets: datasets2
        },
        options: {
            scales: {
                x: { title: { display: true, text: "Дата" } },
                y: { title: { display: true, text: "Курс (₽)" } }
            }
        }
    });
</script>


    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
